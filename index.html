<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Micro Sandbox: Enhanced Edition</title>
<style>
  body { margin: 0; background: #050508; overflow: hidden; font-family: monospace; }
  canvas { display: block; image-rendering: pixelated; image-rendering: crisp-edges; }
  #ui {
    position: fixed; top: 10px; left: 10px; color: #fff; pointer-events: none;
    background: rgba(0,0,0,0.85); padding: 10px; border-radius: 6px; font-size: 11px; 
    border: 2px solid #444;
  }
  #bars { margin-top: 6px; display: flex; gap: 6px; flex-direction: column; }
  .bar { height: 10px; background: #222; border: 1px solid #555; position: relative; border-radius: 2px; overflow: hidden; width: 100px; }
  .bar-fill { height: 100%; transition: width 0.2s; }
  .hp { background: linear-gradient(90deg, #f22, #f55); }
  .hunger { background: linear-gradient(90deg, #fa0, #fc3); }
  #inv-win {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #1a1a2e, #16213e); border: 3px solid #0f3460; 
    color: #fff; padding: 18px; display: none; pointer-events: all; z-index: 100;
    border-radius: 8px; max-height: 75vh; overflow-y: auto; max-width: 500px;
  }
  .btn { 
    background: linear-gradient(135deg, #2c3e50, #34495e); color: #fff; 
    border: 2px solid #555; cursor: pointer; padding: 6px 10px; margin: 2px; 
    font-size: 10px; border-radius: 4px; transition: transform 0.1s;
  }
  .btn:hover { transform: scale(1.03); }
  .btn:active { transform: scale(0.97); }
  #achievements {
    position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.85);
    padding: 8px; border-radius: 6px; border: 2px solid #444; max-width: 180px;
    color: #fff; font-size: 9px; pointer-events: none;
  }
  .achievement {
    background: #1a4d2e; padding: 4px; margin: 2px 0; border-radius: 3px;
    border-left: 3px solid #4f9; animation: slideIn 0.3s;
  }
  @keyframes slideIn {
    from { transform: translateX(200px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  #time-display {
    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.75); padding: 6px 12px; border-radius: 15px;
    color: #fff; font-size: 11px; border: 2px solid #444;
  }
</style>
</head>
<body>

<div id="ui">
  üéÆ <b>WASD</b> –î–≤–∏–∂–µ–Ω–∏–µ | <b>E</b> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å | <b>T</b> –¢–æ—Ä–≥–æ–≤–∞—Ç—å | <b>1-9</b> –°–ª–æ—Ç | <b>F</b> –§–∞–∫–µ–ª<br>
  <div id="status">üî® –†—É–∫–∞: Stone (0)</div>
  <div id="bars">
    <div>‚ù§Ô∏è <div class="bar"><div class="bar-fill hp" id="hp-bar" style="width:100%"></div></div></div>
    <div>üçñ <div class="bar"><div class="bar-fill hunger" id="hunger-bar" style="width:100%"></div></div></div>
  </div>
  <div id="trade-msg" style="color: #ff0; display:none; margin-top: 6px;">üí∞ T - –æ–±–º–µ–Ω (10 —Å–ª–∏—Ç–∫–æ–≤ = 1 –º–æ–Ω–µ—Ç–∞)</div>
</div>

<div id="time-display">
  <span id="time-icon">‚òÄÔ∏è</span> <span id="time-text">–î–µ–Ω—å</span> | –ì–ª—É–±–∏–Ω–∞: <span id="depth">0</span>–º
</div>

<div id="achievements">
  <b>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>
  <div id="achievement-list"></div>
</div>

<div id="inv-win">
  <h2 style="margin:0 0 12px 0; text-align:center; color:#4f9;">üì¶ –ò–ù–í–ï–ù–¢–ê–†–¨</h2>
  <div id="full-inv" style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin-bottom:12px;"></div>
  <hr style="border-color:#444;">
  <h3 style="color:#4f9; margin:8px 0;">‚öíÔ∏è –ö—Ä–∞—Ñ—Ç</h3>
  <button class="btn" onclick="craft('Iron Bar', {Iron: 2})">üî© –ñ–µ–ª–µ–∑–Ω—ã–π —Å–ª–∏—Ç–æ–∫ (2)</button>
  <button class="btn" onclick="craft('Silver Bar', {Silver: 2})">‚ö™ –°–µ—Ä–µ–±—Ä—è–Ω—ã–π —Å–ª–∏—Ç–æ–∫ (2)</button>
  <button class="btn" onclick="craft('Gold Bar', {Gold: 2})">üü° –ó–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫ (2)</button>
  <button class="btn" onclick="craft('Torch', {Coal: 1, Wood: 1})">üî¶ –§–∞–∫–µ–ª (—É–≥–æ–ª—å+–¥–µ—Ä–µ–≤–æ)</button>
  <br>
  <button class="btn" onclick="craft('Copper Pickaxe', {Copper: 25})">‚õèÔ∏è –ú–µ–¥–Ω–∞—è –∫–∏—Ä–∫–∞ (25)</button>
  <button class="btn" onclick="craft('Iron Shovel', {Iron: 25})">üî® –ñ–µ–ª–µ–∑–Ω–∞—è –ª–æ–ø–∞—Ç–∞ (25)</button>
  <button class="btn" onclick="craft('Bucket', {Iron: 12})">ü™£ –í–µ–¥—Ä–æ (12)</button>
  <h3 style="color:#4f9; margin:8px 0;">üõí –ú–∞–≥–∞–∑–∏–Ω</h3>
  <button class="btn" onclick="buy('Super Jump', 500)">ü¶ò –°—É–ø–µ—Ä-–ø—Ä—ã–∂–æ–∫ (500)</button>
  <button class="btn" onclick="buy('Speed Boots', 1000)">üë¢ –°–∫–æ—Ä–æ—Å—Ç—å (1000)</button>
  <button class="btn" onclick="buy('Bread', 5)">üçû –•–ª–µ–± +20 (5)</button>
  <br><button class="btn" style="width:100%; margin-top:8px; background:#c33;" onclick="toggleInv()">‚ùå –ó–ê–ö–†–´–¢–¨</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d", { alpha: false });

const TILE = 8;
const TYPES = {
  0: { name: "Air", color: "transparent", light: 0 },
  1: { name: "Stone", color: "#555", light: 0 },
  2: { name: "Grass", color: "#3a4", light: 0 },
  3: { name: "Dirt", color: "#642", light: 0 },
  4: { name: "Coal", color: "#222", light: 0 },
  5: { name: "Iron", color: "#adb", light: 0 },
  6: { name: "Gold", color: "#fd0", light: 0 },
  7: { name: "Copper", color: "#d74", light: 0 },
  8: { name: "Diamond", color: "#0ef", light: 4 },
  9: { name: "Ruby", color: "#f33", light: 1 },
  10: { name: "Emerald", color: "#2f6", light: 1 },
  11: { name: "Forge", color: "#a44", label: "‚öíÔ∏è" },
  12: { name: "Silver", color: "#ddd", light: 0 },
  13: { name: "Sand", color: "#dc8", light: 0 },
  14: { name: "Clay", color: "#a86", light: 0 },
  15: { name: "Obsidian", color: "#213", light: 0 },
  16: { name: "Torch", color: "#fa0", light: 8 },
  17: { name: "Water", color: "#06f", liquid: true, light: 0 },
  18: { name: "Lava", color: "#f50", liquid: true, light: 2 },
  19: { name: "Coin", color: "#ff0", light: 3 },
  20: { name: "Wood", color: "#753", light: 0 },
  21: { name: "Leaves", color: "#262", light: 0 }
};

let world = {};
let inventory = { "Stone": 10, "Iron": 5, "Coin": 0, "Wood": 5, "Coal": 3 };
let selectedBlock = "Stone";
let isInvOpen = false;
let tools = { pickaxe: false, shovel: false };
let particles = [];

// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –º–µ–Ω—å—à–µ –æ–±–ª–∞–∫–æ–≤
let clouds = Array.from({length: 12}, () => ({ 
  x: Math.random() * 1200, 
  y: Math.random() * 250 + 120, 
  w: Math.random() * 35 + 18,
  speed: Math.random() * 0.12 + 0.04
}));

let gameTime = 0;
let playerStats = { hp: 100, maxHp: 100, hunger: 100, maxHunger: 100 };
let achievements = [];
let frameCount = 0;

function addAchievement(text) {
  if (achievements.includes(text)) return;
  achievements.push(text);
  const list = document.getElementById("achievement-list");
  const div = document.createElement("div");
  div.className = "achievement";
  div.textContent = text;
  list.appendChild(div);
  setTimeout(() => div.remove(), 4000);
}

// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∫–µ—à –¥–ª—è —à—É–º–∞
const noiseCache = {};
function getNoise(x) {
  if (!noiseCache[x]) noiseCache[x] = Math.sin(x * 0.15);
  return noiseCache[x];
}

function generateBlock(x, y) {
  const key = `${x}_${y}`;
  if (world[key] !== undefined) return world[key];
  
  let type = 0;
  const ground = 60;

  if (y === ground) type = 2;
  else if (y === ground + 1) type = 3;
  else if (y > ground + 1) {
    let r = Math.random();
    if (y > 120 && r < 0.012) type = 8; // –ê–ª–º–∞–∑—ã
    else if (y > 100 && r < 0.002) type = 15; // –û–±—Å–∏–¥–∏–∞–Ω
    else if (r < 0.001) type = 18; // –õ–∞–≤–∞
    else if (r < 0.003) type = 10; // –ò–∑—É–º—Ä—É–¥
    else if (r < 0.035) type = 5; // –ñ–µ–ª–µ–∑–æ
    else if (r < 0.05) type = 7; // –ú–µ–¥—å
    else if (r < 0.004) type = 9; // –†—É–±–∏–Ω
    else if (r < 0.06) type = 6; // –ó–æ–ª–æ—Ç–æ
    else if (r < 0.07) type = 12; // –°–µ—Ä–µ–±—Ä–æ
    else if (r < 0.09) type = 4; // –£–≥–æ–ª—å
    else if (r < 0.10) type = 14; // –ì–ª–∏–Ω–∞
    else type = 1;
  }

  // –ü–µ—Å–æ–∫ —É –≤–æ–¥—ã
  if (y === ground && getNoise(x) > 0.85) type = 13;
  if (y === ground && getNoise(x * 1.2) > 0.92) type = 17;

  // –ó–¥–∞–Ω–∏—è —Ä–µ–∂–µ
  if (y === ground - 1 && x % 200 === 0) type = 11;

  // –î–µ—Ä–µ–≤—å—è
  if (y < ground && y > ground - 5 && x % 70 === 0) {
    type = y > ground - 4 ? 20 : 21;
  }

  world[key] = type;
  return type;
}

const player = { x: 100, y: 400, vx: 0, vy: 0, w: 5, h: 5, grounded: false, speedBoost: 1, jumpBoost: 1 };

// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –º–µ–Ω—å—à–µ NPC –∏ –ø—Ç–∏—Ü
const npcs = Array.from({length: 3}, () => ({ 
  x: Math.random()*400, y: 476, targetX: Math.random()*400, speed: 0.25, 
  color: `hsl(${Math.random()*360}, 65%, 55%)` 
}));
const birds = Array.from({length: 10}, () => ({ 
  x: Math.random()*600, y: 250, vx: (Math.random()-0.5)*0.4, vy: 0 
}));

function createParticles(x, y, color) {
  // –ú–µ–Ω—å—à–µ —á–∞—Å—Ç–∏—Ü
  for (let i = 0; i < 4; i++) {
    particles.push({
      x, y,
      vx: (Math.random() - 0.5) * 1.5,
      vy: (Math.random() - 0.5) * 1.5 - 0.8,
      life: 15,
      color
    });
  }
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.08;
    p.life--;
    if (p.life <= 0) particles.splice(i, 1);
  }
}

// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª—è–µ–º –∂–∏–¥–∫–æ—Å—Ç–∏ —Ä–µ–∂–µ
function updateLiquids() {
  if (frameCount % 5 !== 0) return;
  const keys = Object.keys(world);
  const maxUpdates = 15; // –õ–∏–º–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∑–∞ –∫–∞–¥—Ä
  let updates = 0;
  
  for (let key of keys) {
    if (updates >= maxUpdates) break;
    if (world[key] === 17 || world[key] === 18) {
      if (Math.random() > 0.25) continue;
      let [x, y] = key.split('_').map(Number);
      if (generateBlock(x, y + 1) === 0) {
        world[`${x}_${y+1}`] = world[key];
        updates++;
      } else if (generateBlock(x + 1, y) === 0 && Math.random() > 0.5) {
        world[`${x+1}_${y}`] = world[key];
        updates++;
      } else if (generateBlock(x - 1, y) === 0 && Math.random() > 0.5) {
        world[`${x-1}_${y}`] = world[key];
        updates++;
      }
    }
  }
}

window.keys = {};
window.onkeydown = (e) => {
  window.keys[e.key.toLowerCase()] = true;
  if (e.key === 'e') toggleInv();
  if (e.key === 't') tryTrade();
  if (e.key === 'f') placeTorch();
  const nums = ["Stone", "Dirt", "Grass", "Wood", "Diamond", "Gold", "Iron", "Coin", "Torch"];
  if (e.key >= '1' && e.key <= '9') { 
    selectedBlock = nums[e.key-1]; 
    updateUI(); 
  }
};
window.onkeyup = (e) => window.keys[e.key.toLowerCase()] = false;

function placeTorch() {
  if ((inventory["Torch"] || 0) > 0) {
    const tx = Math.floor(player.x / TILE);
    const ty = Math.floor(player.y / TILE);
    if (generateBlock(tx, ty - 1) === 0) {
      world[`${tx}_${ty-1}`] = 16;
      inventory["Torch"]--;
      updateUI();
    }
  }
}

function tryTrade() {
  const npc = npcs.find(n => Math.hypot(n.x - player.x, n.y - player.y) < 25);
  if (npc && (inventory["Iron Bar"] || 0) >= 10) {
    inventory["Iron Bar"] -= 10;
    inventory["Coin"] = (inventory["Coin"] || 0) + 1;
    addAchievement("üí∞ –ü–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞!");
    updateUI();
  }
}

function updateUI() {
  document.getElementById("status").innerText = `üî® –†—É–∫–∞: ${selectedBlock} (${inventory[selectedBlock]||0})`;
  const inv = document.getElementById("full-inv");
  inv.innerHTML = Object.entries(inventory)
    .filter(i => i[1] > 0)
    .map(i => `<div style="background:#222; padding:5px; border-radius:3px; border:1px solid #444;">${i[0]}: <b>${i[1]}</b></div>`)
    .join("");
  
  document.getElementById("hp-bar").style.width = (playerStats.hp / playerStats.maxHp * 100) + "%";
  document.getElementById("hunger-bar").style.width = (playerStats.hunger / playerStats.maxHunger * 100) + "%";
}

function craft(item, req) {
  for (let r in req) if ((inventory[r]||0) < req[r]) return;
  for (let r in req) inventory[r] -= req[r];
  inventory[item] = (inventory[item]||0) + 1;
  if (item.includes("Pickaxe")) { tools.pickaxe = true; addAchievement("‚õèÔ∏è –ü–µ—Ä–≤–∞—è –∫–∏—Ä–∫–∞!"); }
  if (item.includes("Shovel")) { tools.shovel = true; addAchievement("üî® –ù–∞—Å—Ç–æ—è—â–∏–π —à–∞—Ö—Ç—ë—Ä!"); }
  updateUI();
}

function buy(item, cost) {
  if ((inventory["Coin"] || 0) < cost) return;
  inventory["Coin"] -= cost;
  
  if (item === "Super Jump") { player.jumpBoost = 1.5; addAchievement("ü¶ò –ü—Ä—ã–≥—É–Ω!"); }
  else if (item === "Speed Boots") { player.speedBoost = 1.5; addAchievement("üë¢ –ë—ã—Å—Ç—Ä—ã–µ –Ω–æ–≥–∏!"); }
  else if (item === "Bread") { 
    playerStats.hunger = Math.min(playerStats.maxHunger, playerStats.hunger + 20);
    addAchievement("üçû –í–∫—É—Å–Ω–æ!");
  }
  updateUI();
}

function toggleInv() {
  isInvOpen = !isInvOpen;
  document.getElementById("inv-win").style.display = isInvOpen ? "block" : "none";
  updateUI();
}

canvas.onmousedown = (e) => {
  if (isInvOpen) return;
  const wx = Math.floor((e.clientX + camX) / TILE);
  const wy = Math.floor((e.clientY + camY) / TILE);
  const b = generateBlock(wx, wy);
  
  if (b > 0) {
    const blockName = TYPES[b].name;
    inventory[blockName] = (inventory[blockName] || 0) + 1;
    createParticles(wx * TILE, wy * TILE, TYPES[b].color);
    world[`${wx}_${wy}`] = 0;
    
    if (blockName === "Diamond" && (inventory["Diamond"] || 0) === 1) addAchievement("üíé –ü–µ—Ä–≤—ã–π –∞–ª–º–∞–∑!");
    if (blockName === "Gold" && (inventory["Gold"] || 0) === 1) addAchievement("üü° –ó–æ–ª–æ—Ç–∞—è –ª–∏—Ö–æ—Ä–∞–¥–∫–∞!");
  } else if (inventory[selectedBlock] > 0) {
    const id = Object.keys(TYPES).find(k => TYPES[k].name === selectedBlock);
    world[`${wx}_${wy}`] = parseInt(id);
    inventory[selectedBlock]--;
  }
  updateUI();
};

let camX = 0, camY = 0;

// –ö–µ—à –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ—Å–≤–µ—â–µ–Ω–∏—è —Ñ–∞–∫–µ–ª–æ–≤
let torchCache = new Map();

function loop() {
  frameCount++;
  
  // –î–µ–Ω—å/–Ω–æ—á—å
  gameTime += 0.0008;
  const dayProgress = (Math.sin(gameTime) + 1) / 2;
  const isDay = dayProgress > 0.3;
  
  // –ù–µ–±–æ
  const r = Math.floor(135*dayProgress);
  const g = Math.floor(206*dayProgress);
  const b = Math.floor(235*dayProgress);
  ctx.fillStyle = isDay ? `rgb(${r},${g},${b})` : `rgb(10,10,${Math.floor(26+20*dayProgress)})`;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // –û–±–ª–∞–∫–∞ (—Ç–æ–ª—å–∫–æ –≤ –¥–µ–Ω—å –∏ —Ä–µ–∂–µ)
  if (isDay && frameCount % 2 === 0) {
    ctx.fillStyle = `rgba(255,255,255,${0.25*dayProgress})`;
    clouds.forEach(c => {
      c.x += c.speed;
      if (c.x > 1200) c.x = -c.w;
      ctx.fillRect(c.x - camX * 0.5, c.y - camY * 0.3, c.w, 12);
    });
  }

  if (!isInvOpen) {
    const speed = 0.4 * player.speedBoost;
    if (window.keys["a"]) player.vx -= speed;
    if (window.keys["d"]) player.vx += speed;
    if ((window.keys["w"] || window.keys[" "]) && player.grounded) { 
      player.vy = -3.8 * player.jumpBoost; 
      player.grounded = false; 
    }
    player.vy += 0.22; 
    player.vx *= 0.85;
    
    if (!checkCol(player.x + player.vx, player.y)) player.x += player.vx; 
    else player.vx = 0;
    
    player.grounded = false;
    if (!checkCol(player.x, player.y + player.vy)) player.y += player.vy; 
    else { 
      if (player.vy > 0) player.grounded = true; 
      player.vy = 0; 
    }

    camX += (player.x - camX - canvas.width / 2) * 0.1;
    camY += (player.y - camY - canvas.height / 2) * 0.1;
  }

  // –°—Ç–∞—Ç—ã (—Ä–µ–∂–µ)
  if (frameCount % 60 === 0) {
    if (Math.random() < 0.3) playerStats.hunger = Math.max(0, playerStats.hunger - 1);
    if (playerStats.hunger === 0 && Math.random() < 0.5) playerStats.hp = Math.max(0, playerStats.hp - 1);
  }

  updateLiquids();
  updateParticles();

  // NPC (–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∂–µ)
  let nearNPC = false;
  if (frameCount % 2 === 0) {
    npcs.forEach(n => {
      n.x += (n.x < n.targetX ? 0.25 : -0.25);
      if (Math.abs(n.x - n.targetX) < 5) n.targetX = player.x + (Math.random()-0.5)*300;
      if (Math.hypot(n.x - player.x, n.y - player.y) < 25) nearNPC = true;
    });
  }
  // –†–∏—Å—É–µ–º NPC
  npcs.forEach(n => {
    ctx.fillStyle = n.color; 
    ctx.fillRect(n.x - camX, n.y - camY, 5, 6);
    ctx.fillStyle = "#fff";
    ctx.fillRect(n.x - camX + 1, n.y - camY + 1, 1, 1);
  });
  document.getElementById("trade-msg").style.display = nearNPC ? "block" : "none";

  // –ü—Ç–∏—Ü—ã (–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∂–µ)
  if (frameCount % 3 === 0) {
    birds.forEach(b => {
      b.x += b.vx;
      b.y += (Math.random()-0.5)*0.5;
      if (b.x < 0 || b.x > 1000) b.vx *= -1;
    });
  }
  // –†–∏—Å—É–µ–º –ø—Ç–∏—Ü
  birds.forEach(b => {
    ctx.fillStyle = "#fff"; 
    ctx.fillRect(b.x - camX, b.y - camY, 2, 2);
    ctx.fillRect(b.x - camX - 2, b.y - camY, 1, 1);
    ctx.fillRect(b.x - camX + 2, b.y - camY, 1, 1);
  });

  // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —Å—Ç—Ä–æ–≥–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã —Ä–µ–Ω–¥–µ—Ä–∞
  const sx = Math.floor(camX / TILE) - 1;
  const ex = sx + Math.ceil(canvas.width / TILE) + 2;
  const sy = Math.floor(camY / TILE) - 1;
  const ey = sy + Math.ceil(canvas.height / TILE) + 2;

  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à —Ñ–∞–∫–µ–ª–æ–≤ —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ 10 –∫–∞–¥—Ä–æ–≤
  if (frameCount % 10 === 0) {
    torchCache.clear();
    for (let x = sx - 4; x < ex + 4; x++) {
      for (let y = sy - 4; y < ey + 4; y++) {
        if (generateBlock(x, y) === 16) {
          torchCache.set(`${x}_${y}`, { x, y });
        }
      }
    }
  }

  // –†–µ–Ω–¥–µ—Ä –º–∏—Ä–∞
  for (let x = sx; x < ex; x++) {
    for (let y = sy; y < ey; y++) {
      const type = generateBlock(x, y);
      if (type === 0) continue;

      let depthShade = Math.max(0, 1 - (y - 60) / 80);
      let torchLight = 0;
      
      // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ—Ç–∞ –æ—Ç —Ñ–∞–∫–µ–ª–æ–≤
      torchCache.forEach(torch => {
        let td = Math.hypot(x - torch.x, y - torch.y);
        if (td < 4) torchLight = Math.max(torchLight, 1 - td / 4);
      });
      
      let baseLight = isDay ? depthShade * 0.7 : depthShade * 0.2;
      let light = Math.max(0.05, baseLight + torchLight);
      
      if (TYPES[type].light > 0) light = 1;

      ctx.globalAlpha = Math.min(1, light);
      ctx.fillStyle = TYPES[type].color;
      ctx.fillRect(x * TILE - camX, y * TILE - camY, TILE, TILE);
      
      if (TYPES[type].label) {
        ctx.globalAlpha = 1;
        ctx.fillStyle = "#fff";
        ctx.font = "9px monospace";
        ctx.fillText(TYPES[type].label, x * TILE - camX + 1, y * TILE - camY + 6);
      }
    }
  }
  
  ctx.globalAlpha = 1;
  
  // –ß–∞—Å—Ç–∏—Ü—ã
  particles.forEach(p => {
    ctx.fillStyle = p.color;
    ctx.globalAlpha = p.life / 15;
    ctx.fillRect(p.x - camX, p.y - camY, 2, 2);
  });
  ctx.globalAlpha = 1;

  // –ò–≥—Ä–æ–∫
  ctx.fillStyle = "#0ff"; 
  ctx.fillRect(player.x - camX, player.y - camY, 5, 5);
  ctx.fillStyle = "#fff";
  ctx.fillRect(player.x - camX + 1, player.y - camY + 1, 1, 1);

  // UI (–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∂–µ)
  if (frameCount % 10 === 0) {
    const depth = Math.max(0, Math.floor((player.y / TILE) - 60));
    document.getElementById("depth").textContent = depth;
    document.getElementById("time-icon").textContent = isDay ? "‚òÄÔ∏è" : "üåô";
    document.getElementById("time-text").textContent = isDay ? "–î–µ–Ω—å" : "–ù–æ—á—å";
  }

  requestAnimationFrame(loop);
}

function checkCol(nx, ny) {
  for (let ix = Math.floor(nx/TILE); ix <= Math.floor((nx+5)/TILE); ix++) {
    for (let iy = Math.floor(ny/TILE); iy <= Math.floor((ny+5)/TILE); iy++) {
      let t = generateBlock(ix, iy);
      if (t > 0 && t !== 17 && t !== 18 && t !== 16) return true;
    }
  }
  return false;
}

canvas.width = window.innerWidth; 
canvas.height = window.innerHeight;
window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

updateUI();
loop();
</script>
</body>
</html>