<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Micro Sandbox: Ultimate Edition</title>
<style>
  body { margin: 0; background: #020205; overflow: hidden; font-family: monospace; }
  canvas { display: block; image-rendering: pixelated; }
  #ui {
    position: fixed; top: 10px; left: 10px; color: #fff; pointer-events: none;
    background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; font-size: 11px;
  }
  #inv-win {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: #1a1a1a; border: 2px solid #444; color: #fff; padding: 15px;
    display: none; pointer-events: all; z-index: 100; max-height: 80vh; overflow-y: auto;
  }
  .btn { background: #333; color: #fff; border: 1px solid #555; cursor: pointer; padding: 4px; margin: 2px; font-size: 10px; }
</style>
</head>
<body>

<div id="ui">
  WASD - Ходить | E - Инвентарь | 1-7 - Выбор блока<br>
  <div id="status">Рука: Stone</div>
  <div id="save-msg" style="color:#0f0; opacity:0; transition: 1s;">Мир сохранен!</div>
</div>

<div id="inv-win">
  <h3>КРАФТ И ИНВЕНТАРЬ</h3>
  <div id="full-inv"></div>
  <hr>
  <button class="btn" onclick="craft('Silver Bar', {Silver: 2})">Серебряный слиток (2 руды)</button>
  <button class="btn" onclick="craft('Gold Bar', {Gold: 2})">Золотой слиток (2 руды)</button>
  <button class="btn" onclick="craft('Copper Pickaxe', {Copper: 3})">Медная кирка (3 меди)</button>
  <button class="btn" onclick="craft('Iron Shovel', {Iron: 3})">Железная лопата (3 железа)</button>
  <button class="btn" onclick="craft('Bucket', {Iron: 3})">Ведро (для воды/лавы)</button>
  <br>
  <button class="btn" style="width:100%; margin-top:10px;" onclick="toggleInv()">ЗАКРЫТЬ</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* ================= TYPES & CONFIG ================= */
const TILE = 8;
const TYPES = {
  0: { name: "Air", color: "transparent", light: 0 },
  1: { name: "Stone", color: "#444", light: 0 },
  2: { name: "Grass", color: "#2a2", light: 0 },
  3: { name: "Dirt", color: "#532", light: 0 },
  4: { name: "Coal", color: "#111", light: 0 },
  5: { name: "Iron", color: "#bdc", light: 0 },
  6: { name: "Gold", color: "#fd0", light: 0 },
  7: { name: "Copper", color: "#d74", light: 0 },
  8: { name: "Diamond", color: "#0ef", light: 5 },
  9: { name: "Ruby", color: "#f22", light: 4 },
  10: { name: "Emerald", color: "#2f5", light: 4 },
  11: { name: "Forge", color: "#933", label: "⚒️ FORGE" },
  12: { name: "Silver", color: "#e3e3e3", light: 0 },
  17: { name: "Water", color: "rgba(0, 100, 255, 0.7)", liquid: true, light: 0 },
  18: { name: "Lava", color: "#f50", liquid: true, light: 6 }
};

let world = {};
let inventory = { "Stone": 20, "Water": 5, "Lava": 2 };
let selectedBlock = "Stone";
let isInvOpen = false;
let tools = { pickaxe: false, shovel: false };

/* ================= SAVE SYSTEM ================= */
function saveGame() {
    const data = { world, inventory, playerPos: {x: player.x, y: player.y}, tools };
    localStorage.setItem('microSandboxSave', JSON.stringify(data));
    const msg = document.getElementById("save-msg");
    msg.style.opacity = 1;
    setTimeout(() => msg.style.opacity = 0, 2000);
}

function loadGame() {
    const saved = localStorage.getItem('microSandboxSave');
    if (saved) {
        const data = JSON.parse(saved);
        world = data.world;
        inventory = data.inventory;
        player.x = data.playerPos.x;
        player.y = data.playerPos.y;
        tools = data.tools;
    }
}

/* ================= WORLD GEN ================= */
function generateBlock(x, y) {
  const key = `${x}_${y}`;
  if (world[key] !== undefined) return world[key];
  
  let type = 0;
  const ground = 60;

  if (y === ground) {
    type = 2; // Трава
  } else if (y === ground + 1) {
    type = 3; // Грязь
  } else if (y > ground + 1) {
    type = 1; // Камень (основа)
    
    // ГЕНЕРАЦИЯ РУД (Исправлено)
    let r = Math.random();
    
    // Алмазы - очень глубоко и редкие
    if (y > 90 && r < 0.02) {
      type = 8; 
    } 
    // Рубин и Изумруд - глубоко
    else if (y > 80 && r < 0.03) {
      type = (Math.random() > 0.5) ? 9 : 10;
    }
    // Золото и Серебро
    else if (y > 70 && r < 0.04) {
      type = (Math.random() > 0.5) ? 6 : 12;
    }
    // Железо, Уголь, Медь - везде в камне
    else if (r < 0.05) {
      type = 5; // Железо
    } else if (r < 0.08) {
      type = 4; // Уголь
    } else if (r < 0.10) {
      type = 7; // Медь
    } else if (r < 0.12) {
      type = 18; // Лава (карманы в камне)
    }
  }
  
  // Редкие озера воды на поверхности
  if (y === ground && Math.sin(x * 0.2) > 0.9) type = 17;

  // Здания (оставляем как было)
  if (y === ground - 1 && x % 150 === 0) type = 11;

  world[key] = type;
  return type;
}

/* ================= ENTITIES ================= */
const player = { x: 50, y: 450, vx: 0, vy: 0, w: 5, h: 5, grounded: false };
const npcs = [
  { x: 20, y: 470, targetX: 100, speed: 0.3, color: "#f0f", w: 4, h: 4 },
  { x: 150, y: 470, targetX: 50, speed: 0.2, color: "#0ff", w: 4, h: 4 },
  { x: -50, y: 470, targetX: 10, speed: 0.4, color: "#ff0", w: 4, h: 4 }
];
const birds = Array.from({length: 18}, () => ({ x: Math.random()*500, y: 470, vx: 0, vy: 0 }));

/* ================= LOGIC ================= */
function updateLiquids() {
    const keys = Object.keys(world);
    for (let key of keys) {
        if (world[key] === 17 || world[key] === 18) {
            let [x, y] = key.split('_').map(Number);
            if (Math.random() > 0.1) continue;
            if (generateBlock(x, y + 1) === 0) {
                world[`${x}_${y+1}`] = world[key];
            } else if (generateBlock(x + 1, y) === 0) {
                world[`${x+1}_${y}`] = world[key];
            } else if (generateBlock(x - 1, y) === 0) {
                world[`${x-1}_${y}`] = world[key];
            }
        }
    }
}

function updateEntities() {
    // NPC movement
    npcs.forEach(n => {
        if (n.x < n.targetX) n.x += n.speed; else n.x -= n.speed;
        if (Math.abs(n.x - n.targetX) < 2) n.targetX = (Math.random() - 0.5) * 400;
    });
    // Birds
    birds.forEach(b => {
        if (Math.random() < 0.02) b.vx = (Math.random() - 0.5) * 2;
        if (Math.random() < 0.01 && b.y > 470) b.vy = -2;
        b.vy += 0.1; b.x += b.vx; b.y += b.vy;
        if (b.y > 475) { b.y = 475; b.vy = 0; }
    });
}

function checkCol(nx, ny) {
  for (let ix = Math.floor(nx/TILE); ix <= Math.floor((nx+player.w)/TILE); ix++) {
    for (let iy = Math.floor(ny/TILE); iy <= Math.floor((ny+player.h)/TILE); iy++) {
      let t = generateBlock(ix, iy);
      if (t > 0 && !TYPES[t].liquid && t !== 11) return true;
    }
  }
  return false;
}

/* ================= CORE LOOP ================= */
let camX = 0, camY = 0;
window.keys = {};
window.onkeydown = (e) => {
    window.keys[e.key.toLowerCase()] = true;
    if (e.key === 'e') toggleInv();
    const nums = ["Stone", "Dirt", "Grass", "Water", "Lava", "Coal", "Iron"];
    if (e.key >= 1 && e.key <= 7) { selectedBlock = nums[e.key-1]; updateUI(); }
};
window.onkeyup = (e) => window.keys[e.key.toLowerCase()] = false;

canvas.onmousedown = (e) => {
  if (isInvOpen) return;
  const wx = Math.floor((e.clientX + camX) / TILE);
  const wy = Math.floor((e.clientY + camY) / TILE);
  const block = generateBlock(wx, wy);

  if (block > 0 && block !== 11) {
    inventory[TYPES[block].name] = (inventory[TYPES[block].name] || 0) + 1;
    world[`${wx}_${wy}`] = 0;
  } else if (block === 0 && inventory[selectedBlock] > 0) {
    const id = Object.keys(TYPES).find(k => TYPES[k].name === selectedBlock);
    world[`${wx}_${wy}`] = parseInt(id);
    inventory[selectedBlock]--;
  }
  updateUI();
};

function toggleInv() {
    isInvOpen = !isInvOpen;
    document.getElementById("inv-win").style.display = isInvOpen ? "block" : "none";
    updateUI();
}

function updateUI() {
    document.getElementById("status").innerText = `Рука: ${selectedBlock} (${inventory[selectedBlock]||0})`;
    document.getElementById("full-inv").innerHTML = Object.entries(inventory).filter(i => i[1]>0).map(i => `<div>${i[0]}: ${i[1]}</div>`).join("");
}

function craft(item, req) {
    for (let r in req) if ((inventory[r]||0) < req[r]) return;
    for (let r in req) inventory[r] -= req[r];
    inventory[item] = (inventory[item]||0) + 1;
    if (item.includes("Pickaxe")) tools.pickaxe = true;
    updateUI();
}

function loop() {
  if (!isInvOpen) {
    let speed = 0.4 + (tools.pickaxe ? 0.3 : 0);
    if (window.keys["a"]) player.vx -= speed;
    if (window.keys["d"]) player.vx += speed;
    if ((window.keys["w"] || window.keys[" "]) && player.grounded) { player.vy = -3.5; player.grounded = false; }

    player.vy += 0.2; player.vx *= 0.8;
    if (!checkCol(player.x + player.vx, player.y)) player.x += player.vx; else player.vx = 0;
    player.grounded = false;
    if (!checkCol(player.x, player.y + player.vy)) player.y += player.vy; 
    else { if (player.vy > 0) player.grounded = true; player.vy = 0; }

    camX += (player.x - camX - canvas.width / 2) * 0.1;
    camY += (player.y - camY - canvas.height / 2) * 0.1;
  }

  updateEntities();
  if (Math.random() < 0.1) updateLiquids();

  // Rendering
  ctx.fillStyle = "#0a0a1a";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const sx = Math.floor(camX / TILE) - 5;
  const ex = sx + Math.ceil(canvas.width / TILE) + 10;
  const sy = Math.floor(camY / TILE) - 5;
  const ey = sy + Math.ceil(canvas.height / TILE) + 10;

  for (let x = sx; x < ex; x++) {
    for (let y = sy; y < ey; y++) {
      const type = generateBlock(x, y);
      if (type === 0) continue;
      
      let dist = Math.hypot(x - Math.floor(player.x/TILE), y - Math.floor(player.y/TILE));
      let light = Math.max(0, 1 - dist / 10) + 0.2; // Чуть светлее база (+0.2)
      if (TYPES[type].light > 0) light += 0.6;

      ctx.globalAlpha = Math.min(1, light);
      ctx.fillStyle = TYPES[type].color;
      ctx.fillRect(x * TILE - camX, y * TILE - camY, TILE, TILE);
      if (TYPES[type].label) {
          ctx.fillStyle = "#fff"; ctx.font = "5px Arial";
          ctx.fillText(TYPES[type].label, x * TILE - camX, y * TILE - camY - 2);
      }
    }
  }
  ctx.globalAlpha = 1;

  // Draw Entities
  npcs.forEach(n => { ctx.fillStyle = n.color; ctx.fillRect(n.x - camX, n.y - camY, n.w, n.h); });
  birds.forEach(b => { ctx.fillStyle = "#fff"; ctx.fillRect(b.x - camX, b.y - camY, 2, 2); });
  ctx.fillStyle = "#0ff"; ctx.fillRect(player.x - camX, player.y - camY, player.w, player.h);

  requestAnimationFrame(loop);
}

/* ================= START ================= */
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
loadGame();
setInterval(saveGame, 5000); // Автосохранение каждые 5 сек
updateUI();
loop();
</script>
</body>
</html>